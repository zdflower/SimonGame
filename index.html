<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Simon Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<link rel="stylesheet" href="styles.css" />
</head>
<body>
<main class="container">
<button class="colores" id="red"></button>

<button class="colores" id="green"></button>
<div id="display">
	<h3>Simon</h3>
	<button id="interruptor">On/Off</button>
	<button id="modo">Normal</button><!-- podría ser que se clickee y cambie el texto de Normal a Estricto y viceversa -->
	<button id="restart">Start</button>
	<div id="etapa"></div>
</div>
<button class="colores" id="blue"></button>

<button class="colores" id="yellow"></button>

<div id="msg"></div>

<audio src="" id="audio" controls>audio</audio>
</main>
<script type="text/javascript" src="jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="simon.js"></script>
<script type="text/javascript">
/* FALTA
-después de mostrar el mensaje de error durante unos instantes y cuando empieza a mostrar de nuevo la secuencia borrar el mensaje de error.
-después de mostrar el mensaje que ganaste, antes de volver a empezar también debería borrarse el msg
- antes de volver a empezar que haya unos segundos de espera.
- que también haya una pausa si te equivocaste antes de que te vuelva a mostrar la secuencia
- también antes de que muestre la etapa debería pausar unos segundos
- los colores con los que se muestran los clicks para la secuencia del simon, hacer que sean como los de un click y no los que puse yo.
- una vez que estén resueltos todos los demás problemas setear la meta en 20 etapas en lugar de 4 o 5 como es ahora.

-revisar todo el código javascript, tal vez algunas de las cosas que están acá sueltas podrían ser parte de la clase simon

- ubicar todo este script js en un archivo aparte
- mejorar el aspecto de la página web
- limpiar el código

en el ejemplo que se muestra en fcc hay un tiempo para que el jugador responda, pasado ese período se da por equivocada la jugada
*/

//tenés varios estados:
//el de mostrar secuencia
//el de input
//el de configuración del modo

var sonido = document.getElementById('audio');
var COLORESmap = {'red': 'pink', 'blue': 'skyblue', 'green': 'lime', 'yellow': 'black'};
    
var SOUNDmap = {'red': 'simonSound1.mp3', 'blue': 'simonSound2.mp3', 'green': 'simonSound3.mp3', 'yellow': 'simonSound4.mp3'};

var sim;
var estricto = false;
var restart = false;
var input = true;
var jugadaOK = true;
var jugador;
var chequeados = 0;
var on = false; //esto para cuando haya un botón de encendido y si on es false se puede cambiar el modo del juego y después clickear en start.

//podría haber un botón con un evento toggle que cuando lo clickeás una vez pone on en true

function start(){
	//ok, pero cómo interrumpís una vez que empezó un juego? con el botón de on/off
	if(on){
		console.log("start");
        $('#msg').css('display', 'none');//"resetea" el mensaje. 
		sim = new Simon();
		//console.log("Etapa: " + sim.getStage());
		siguienteEtapa();
		mostrarSecuencia();
	}
}

function siguienteEtapa(){
	//si ya se llegó a las 20 entonces mostrar el mensaje que ganó y volver a llamar a restart
	//si no agregar nuevo paso
	console.log("siguiente etapa");

	//resetear chequeados
	chequeados = 0;

	if (sim.getStage() > 3){//3 para testear, reemplazar por 20
		mostrarMsgGano(); //¿puede ser que acá haya un problema, un desfasaje entre mostrar mensaje y empezar de nuevo. Porque cuando termina, se ejecuta mostrar mensaje ganó pero no lo llego a ver en la página y rápidamente pasa a reiniciar el juego.
		start();
	} else {
		console.log("antes de agregar etapa");
		console.log(sim.getStage());
		sim.addNewStep();
		console.log("agrego nuevo paso");
	}
	//mostrar la etapa en la página
	$('#etapa').text(sim.getStage());
}
 
//cuando se llama a mostrarSecuencia se supone que ya se empezó a jugar y que hay un simon y al menos se agregó 1 paso
function mostrarSecuencia(){
    input = false;
    console.log(sim.getSequence());
    (function theLoop(count, len, sec){
      var elem = sec[count];//el primer carácter
      setTimeout(function(){
	clickButton(elem);
	if(--len){
	  theLoop(++count,len,sec);
	}
      }, 2000);
    })(0, sim.getSequence().length, sim.getSequence());
    
    input = true;
}

function clickButton(elem){
    $('#' + elem).css('background-color', COLORESmap[elem]);
    playSound(elem);
    setTimeout(function(){
        $('#' + elem).css('background-color', elem);
    }, 300);
}

function manejarJugadaErronea(){
	input = false;
	mostrarMsgError();
	//si el modo es normal, volver a mostrar la secuencia del sim, y al final habilitar el input
	//si el modo es estricto, ir a start 
	(estricto === false )? mostrarSecuencia() : start();
}

function changeMode(){
	if(!on){
		if (!estricto){
			estricto = true;
			console.log('Cambio modo a Estricto');
			$('#modo').text('Estricto');
		} else {
			estricto = false;
			$('#modo').text('Normal');
		}
	}
}

function playSound(snd){
    //¿de dónde salió sonido?
    sonido.setAttribute('src', SOUNDmap[snd]);
	sonido.play();
}
    
$(document).ready(function(){

	$('#etapa').text("--");

	/* setear eventos */
	$('.colores').on('click', function(){
		if(on){
		    var color = $(this).attr('id');

		    /* efecto de sonido al clickear */
            playSound(color);

		    console.log(color);
			console.log("input: ", input);

			if (input){//también podría chequear si on está en true
				jugador = color;

                console.log(sim.getSequence());
				console.log("Stage:" + sim.getStage());
				console.log(sim.getSequence()[chequeados]);

				jugadaOK = sim.getSequence()[chequeados] == jugador;

				console.log("jugadaOK" + jugadaOK);
				
				if(!jugadaOK){
					//desactivás el input
					//llamás a una función que te indica el error y que luego si el modo es normal te vuelve a mostrar la secuencia y después rehabilita el input para que el usuario pueda ingresar su secuencia
					manejarJugadaErronea();
				} else {
					chequeados++;
				}
			}
			//cómo llegás acá? una vez que hiciste bien la secuencia completa

			console.log("chequeados: " + chequeados);
			console.log('stage: ', sim.getStage());
			console.log(sim.getSequence().length);
			console.log(sim.getStage() === sim.getSequence().length);

			if (chequeados >= sim.getSequence().length){
                setTimeout(function(){
                    siguienteEtapa();
				    mostrarSecuencia(); 	
                }, 3000);
			}
		}
	});

	$('#modo').on('click', changeMode);

	$('#restart').on('click', start);

	$('#interruptor').on('click', function(){
		//(on === true)? on = false : true;
		if (on === true){
			$('#etapa').text("--");
			on = false;
			//resetear el display de la etapa

			//y podría sacarles la clase colores a los colores
		} else {
			on = true;
			//y acá le vuelve a poner la clase colores a los colores
		}
		console.log("on? " + on);
	});

});
</script>
</body>
</html>